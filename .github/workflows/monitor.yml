name: Monitor YouTube Channel

on:
  schedule:
    # Run at 8am and 8pm UTC
    - cron: '0 8,20 * * *'
  workflow_dispatch:
    # Allow manual trigger
    inputs:
      force_url:
        description: 'Force process a specific video URL (optional)'
        required: false
        type: string

env:
  WHISPER_MODEL: base
  GPT_MODEL: gpt-4o-mini

jobs:
  check-and-process:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check for new videos
        id: monitor
        if: ${{ !inputs.force_url }}
        env:
          YOUTUBE_CHANNEL_ID: ${{ secrets.YOUTUBE_CHANNEL_ID }}
        run: |
          set +e  # Don't exit on error
          python src/monitor.py 2>&1 | tee monitor_output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          set -e

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Monitor script failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

          if grep -q "Found .* new video" monitor_output.txt; then
            echo "new_video=true" >> $GITHUB_OUTPUT
            VIDEO_URL=$(grep -oP 'https://www.youtube.com/watch\?v=\S+' monitor_output.txt | head -1)
            echo "video_url=${VIDEO_URL}" >> $GITHUB_OUTPUT
            VIDEO_ID=$(echo "$VIDEO_URL" | grep -oP 'v=\K[^&]+')
            echo "video_id=${VIDEO_ID}" >> $GITHUB_OUTPUT
          else
            echo "new_video=false" >> $GITHUB_OUTPUT
          fi

      - name: Set forced URL
        id: forced
        if: ${{ inputs.force_url }}
        run: |
          echo "new_video=true" >> $GITHUB_OUTPUT
          echo "video_url=${{ inputs.force_url }}" >> $GITHUB_OUTPUT

      - name: Get video metadata
        id: metadata
        if: steps.monitor.outputs.new_video == 'true' || steps.forced.outputs.new_video == 'true'
        run: |
          VIDEO_URL="${{ steps.monitor.outputs.video_url || steps.forced.outputs.video_url }}"
          echo "Getting metadata for: $VIDEO_URL"

          # Get video metadata (show errors)
          VIDEO_INFO=$(yt-dlp --print "%(id)s\t%(title)s\t%(upload_date)s" "$VIDEO_URL")
          echo "Raw video info: $VIDEO_INFO"

          VIDEO_ID=$(echo "$VIDEO_INFO" | cut -f1)
          TITLE=$(echo "$VIDEO_INFO" | cut -f2)
          UPLOAD_DATE=$(echo "$VIDEO_INFO" | cut -f3)

          echo "Video ID: $VIDEO_ID"
          echo "Title: $TITLE"
          echo "Upload date: $UPLOAD_DATE"

          # Format date as YYYY-MM-DD (handle empty/missing date)
          if [ -n "$UPLOAD_DATE" ] && [ ${#UPLOAD_DATE} -ge 8 ]; then
            FORMATTED_DATE="${UPLOAD_DATE:0:4}-${UPLOAD_DATE:4:2}-${UPLOAD_DATE:6:2}"
          else
            FORMATTED_DATE=$(date +%Y-%m-%d)
            echo "Warning: Using today's date as fallback"
          fi

          # Sanitize title for filename
          SAFE_TITLE=$(echo "$TITLE" | tr ' ' '_' | tr -cd '[:alnum:]_-' | cut -c1-100)

          # Fallback if title is empty
          if [ -z "$SAFE_TITLE" ]; then
            SAFE_TITLE="$VIDEO_ID"
          fi

          FILENAME="sermon_${FORMATTED_DATE}_${SAFE_TITLE}"

          echo "Filename: $FILENAME"
          echo "video_id=${VIDEO_ID}" >> $GITHUB_OUTPUT
          echo "filename=${FILENAME}" >> $GITHUB_OUTPUT

      - name: Download audio
        if: steps.monitor.outputs.new_video == 'true' || steps.forced.outputs.new_video == 'true'
        run: |
          VIDEO_URL="${{ steps.monitor.outputs.video_url || steps.forced.outputs.video_url }}"
          echo "Downloading: $VIDEO_URL"
          mkdir -p output
          yt-dlp -x --audio-format mp3 -o "output/audio.%(ext)s" "$VIDEO_URL"

      - name: Transcribe audio
        if: steps.monitor.outputs.new_video == 'true' || steps.forced.outputs.new_video == 'true'
        run: |
          echo "Transcribing with Whisper ($WHISPER_MODEL model)..."
          python src/transcribe.py output/audio.mp3 $WHISPER_MODEL

      - name: Segment sermon
        id: segment
        if: steps.monitor.outputs.new_video == 'true' || steps.forced.outputs.new_video == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Segmenting with GPT ($GPT_MODEL)..."
          set +e  # Don't exit on error
          python src/segment.py audio_transcript.json $GPT_MODEL
          EXIT_CODE=$?
          set -e
          if [ $EXIT_CODE -eq 2 ]; then
            echo "No sermon found in video - skipping cleanup"
            echo "sermon_found=false" >> $GITHUB_OUTPUT
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "Segmentation failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          else
            echo "sermon_found=true" >> $GITHUB_OUTPUT
          fi

      - name: Cleanup transcript
        if: (steps.monitor.outputs.new_video == 'true' || steps.forced.outputs.new_video == 'true') && steps.segment.outputs.sermon_found == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Cleaning up transcript..."
          FILENAME="${{ steps.metadata.outputs.filename }}"
          python src/cleanup.py audio_sermon.json $GPT_MODEL "output/${FILENAME}.txt"

      - name: Update state
        if: steps.monitor.outputs.new_video == 'true'
        run: |
          VIDEO_ID="${{ steps.monitor.outputs.video_id }}"
          python -c "
          import json
          from datetime import datetime
          state = {'last_video_id': '${VIDEO_ID}', 'last_check': datetime.utcnow().isoformat()}
          with open('state.json', 'w') as f:
              json.dump(state, f, indent=2)
          "

      - name: Commit results
        if: steps.monitor.outputs.new_video == 'true' || steps.forced.outputs.new_video == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          VIDEO_ID="${{ steps.metadata.outputs.video_id }}"
          FILENAME="${{ steps.metadata.outputs.filename }}"
          SERMON_FOUND="${{ steps.segment.outputs.sermon_found }}"

          # Add the sermon transcript if it exists
          if [ "$SERMON_FOUND" == "true" ]; then
            git add "output/${FILENAME}.txt" || true
          fi
          git add state.json || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "$SERMON_FOUND" == "true" ]; then
              git commit -m "Add sermon: ${FILENAME}"
            else
              git commit -m "Update state: no sermon found in video ${VIDEO_ID}"
            fi
            git push
          fi

      - name: Upload artifact
        if: (steps.monitor.outputs.new_video == 'true' || steps.forced.outputs.new_video == 'true') && steps.segment.outputs.sermon_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: sermon-transcript
          path: output/sermon_*.txt
          retention-days: 30
